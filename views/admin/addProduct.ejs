<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmeta Admin - Add Product</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #1a1a1a;
            color: white;
        }
        .sidebar .nav-link {
            color: #ffffff;
            padding: 0.8rem 1rem;
            opacity: 0.8;
        }
        .sidebar .nav-link:hover {
            opacity: 1;
            background: rgba(255,255,255,0.1);
        }
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.1);
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-auto px-0 sidebar">
                <div class="d-flex flex-column p-3">
                    <h3 class="mb-4">Cosmeta</h3>
                    <ul class="nav nav-pills flex-column gap-2">
                        <li class="nav-item">
                            <a href="/admin/dashboard" class="nav-link">
                                <i class="bi bi-speedometer2 me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/admin/user" class="nav-link">
                                <i class="bi bi-people me-2"></i>Users
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/admin/products" class="nav-link active">
                                <i class="bi bi-box me-2"></i>Products
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/admin/category" class="nav-link">
                                <i class="bi bi-tags me-2"></i>Category
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="/admin/brand" class="nav-link">
                                <i class="bi bi-award me-2"></i>Brands
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="bi bi-cart me-2"></i>Orders
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="bi bi-ticket-perforated me-2"></i>Coupons
                            </a>
                        </li>
                        <li style="margin-bottom: 5%;" class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="bi bi-gift me-2"></i>Offers
                            </a>
                        </li>
                    </ul>
                    <a href="/admin/logout">
                        <button style="margin-left: 9%;" class="btn btn-outline-light mt-auto">
                            <i class="bi bi-box-arrow-right me-2"></i>Logout
                        </button>
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col px-4 py-3">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Add New Product</h2>
                    <a href="/admin/products" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Back to Products
                    </a>
                </div>

                <div class="card">
                    <div class="card-body">
                        <form id="addProductForm" action="/admin/products/add" method="post" enctype="multipart/form-data">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Product Name</label>
                                    <input type="text" class="form-control" name="name" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Brand</label>
                                    <select class="form-select" name="brand" required>
                                        <option value="">Select Brand</option>
                                        <% brands.forEach(function(brand) { %>
                                            <option value="<%= brand._id %>"><%= brand.name %></option>
                                        <% }); %>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" name="category" required>
                                        <option value="">Select Category</option>
                                        <% categories.forEach(function(category) { %>
                                            <option value="<%= category._id %>"><%= category.name %></option>
                                        <% }); %>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Price</label>
                                    <input type="number" class="form-control" name="price" required>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Stock</label>
                                    <input type="number" class="form-control" name="stock" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Product Images (Select up to 3 images)</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="imageInput1" class="form-label">Image 1</label>
                                        <input type="file" id="imageInput1" class="form-control mb-2" accept="image/*" name="images1" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="imageInput2" class="form-label">Image 2</label>
                                        <input type="file" id="imageInput2" class="form-control mb-2" accept="image/*" name="images2">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="imageInput3" class="form-label">Image 3</label>
                                        <input type="file" id="imageInput3" class="form-control mb-2" accept="image/*" name="images3">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Image Previews</label>
                                <div id="imagePreviewContainer" class="row">
                                    <!-- Image previews will appear here -->
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Available Colors</label>
                                <div class="row" id="colorPickerContainer">
                                    <div class="col-md-4 mb-2">
                                      <div class="input-group">
                                        <input type="color" class="form-control form-control-color" name="shades[]" required>
                                        <input type="text" class="form-control" placeholder="Color name" name="colorNames[]" required>
                                      </div>
                                    </div>
                                  </div>
                                  <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="addColorPicker()">Add Another Color</button>
                                  
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" rows="3" name="description" required></textarea>
                            </div>
                            <div class="text-end">
                                <a href="/admin/products" class="btn btn-secondary me-2">Cancel</a>
                                <button type="submit" class="btn btn-primary">Add Product</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function addColorPicker() {
        const container = document.getElementById('colorPickerContainer');
        const newColorPicker = document.createElement('div');
        newColorPicker.className = 'col-md-4 mb-2';
        newColorPicker.innerHTML = `
            <div class="input-group">
            <input type="color" class="form-control form-control-color" name="shades[]" required>
            <input type="text" class="form-control" placeholder="Color name" name="colorNames[]" required>
            </div>
        `;
        container.appendChild(newColorPicker);
        }


        document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("addProductForm");
            const imageInputs = form.querySelectorAll('input[type="file"]');
            const imagePreviewContainer = document.getElementById("imagePreviewContainer");
            const cropInstances = [];

            imageInputs.forEach((imageInput, index) => {
                imageInput.addEventListener("change", function (event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            let imagePreview = document.getElementById(`imagePreview-${index}`);
                            if (!imagePreview) {
                                imagePreview = document.createElement("img");
                                imagePreview.id = `imagePreview-${index}`;
                                imagePreviewContainer.appendChild(imagePreview);
                            }
                            imagePreview.style.display = "block";
                            imagePreview.src = e.target.result;

                            if (cropInstances[index]) {
                                cropInstances[index].destroy();
                            }

                            cropInstances[index] = new Cropper(imagePreview, {
                                aspectRatio: 3/4,
                                viewMode: 1,
                                zoomable: true,
                                scalable: true,
                                cropBoxResizable: true,
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                });
            });

            form.addEventListener("submit", function (event) {
                event.preventDefault();
                const croppedBlobs = [];
                const cropPromises = cropInstances.map((cropper, index) => {
                    return new Promise((resolve, reject) => {
                        if (cropper) {
                            cropper.getCroppedCanvas().toBlob((blob) => {
                                if (blob) {
                                    croppedBlobs.push({ name: `image-${index + 1}.jpg`, blob });
                                    resolve();
                                } else {
                                    reject(new Error("Failed to create blob"));
                                }
                            });
                        } else {
                            resolve();
                        }
                    });
                });

                Promise.all(cropPromises)
                    .then(() => {
                        const formData = new FormData();
                        const formFields = new FormData(form);
                        for (let [key, value] of formFields.entries()) {
                            if (!key.startsWith("images")) {
                                formData.append(key, value);
                            }
                        }
                        croppedBlobs.forEach(({ name, blob }) => {
                            formData.append("images", blob, name);
                        });

                        fetch("/admin/products/add", {
                            method: "POST",
                            body: formData,
                        })
                        .then((response) => {
                            if (!response) {
                                throw new Error('Failed to add product');
                            }
                            return response.json();
                        })
                        .then((data) => {
                            console.log(data);
                            window.location.href = '/admin/products';
                        })
                        .catch((error) => {
                            console.error(error);
                        });
                    })
                    .catch((error) => {
                        console.error(error);
                    });
            });
        });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
</body>
</html>